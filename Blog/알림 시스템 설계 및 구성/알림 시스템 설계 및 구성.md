프로젝트를 설계할 때는 알림 시스템을 간단하게 생각하고 설계했었다. 하지만 알림을 구현하기 시작하면서 재 설계의 필요성을 느꼈다. 
## 알림 시스템의 요구사항 
### 알림 템플릿
먼저 알림 시스템의 템플릿을 알아보자. 
```plain text
배송이 시작되었습니다. [알림 메세지]
https://mypage   [연관된 페이지]
```
### 알림 형태 
| 수신자 | 전송 방법 | 
|:--|:--|
|시스템 관리자 | SSE |
| 가게 사장 | SSE | 
| 구매자 | SSE, SMS | 
알림 전송 방법은 SSE와 문자 메세지를 이용한다. SSE와 문자 메세지의 템플릿을 통일해서 알림 데이터를 다루기 쉽도록 구성했다. 
### 알림 기본 프로세스 
알림이 발생하는 프로세스는 다음 그림과 같다.
![[Pasted image 20231213235723.png]]
1. 액터(구매자, 가게 사장, 시스템 관리자)에 의해 micro service에서 특정 동작이 수행된다. 
2. micro service에서 동작 완료 후 특정 조건을 만족하면 이벤트를 발생 시킨다.
3. AWS SQS 로 메세지를 publish 하게 된다. 
4. notification service 의 특정 SQS listener가 메세지를 polling 한다. 
5. 알림을 전달할 사용자의 Role에 따라 SSE, SMS를 전송하고 알림 정보를 mysql 데이터베이스에 저장한다. 
전체적인 프로세스이다. 특정 이벤트에 대해서는 SNS를 사용하여 여러 SQS가 이벤트를 받는 경우가 발생할 수 있다. 

### 알림 이벤트 전달 객체 설계 
알림은 여러 micro service에서 발생한 이벤트에 의해 전송된다. 주문 생성, 배송 시작, 문의 등록, 답변 등록 등 사용자에게 즉시 상태 변화를 알려줄 수 있어야 한다. 또한 여러 micro service에서 알림 정보를 notification service에 전달하기 때문에 알림 정보를 전달하는 코드는 통일성을 가지면 좋다. 
```java
...
public class NotificationData<T> {  
  @JsonProperty private T whoToNotify;  
  private PublishNotificationInformation publishInformation;  
  
  public static <T> NotificationData<T> notifyData(  
      T data, PublishNotificationInformation publishInformation) {  
    return NotificationData.<T>builder()  
        .whoToNotify(data)  
        .publishInformation(publishInformation)  
        .build();  
  }
```
위 코드는 micro service에서 SQS에 publish 할 데이터를 받는 클래스이다. `whoToNotify`는 타입 T를 부여해 데이터의 형태에 제약을 두지 않았다. 
알림 전달을 한번에 여러명에게 할 수도 있고, 한명에게만 전달할 수도 있다. 또한 알림 형태에 따라 요구되는 속성이 다를 수 있다. 
각 micro service 에서 `notify()`메서드를 호출하여 누구에게 전달할지, 알림 정보는 어떤 것인지를 넣어 SQS에 메세지를 전송하게 된다. 
```java
@SqsListener(  
    value = "${cloud.aws.sqs.question-register-notification-queue.name}",  
    deletionPolicy = SqsMessageDeletionPolicy.NEVER)  
public void consumeQuestionRegisterNotificationQueue(  
    @Payload String message, @Headers Map<String, String> headers, Acknowledgment ack)  
    throws JsonProcessingException {  
  NotificationData<ClassName> questionRegisterNotification =  
      objectMapper.readValue(message, ClassName.class);
...  

  notificationFacadeHandler.publishQuestionRegisterNotification(notification);  
  ack.acknowledge();  
}
```
